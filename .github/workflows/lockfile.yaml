name: Terraform Lockfile Initialization

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lockfile:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0

      - name: Generate lockfile
        run: |
          cd envs/prod
          terraform init \
            -backend=false \
            -lockfile=readonly=false \
            -input=false \
            -no-color \
            -upgrade

          test -f .terraform.lock.hcl

      - name: View Files
        run: |
          ls -l -a
          ls -l .terraform

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: lockfile/update
          branch-suffix: timestamp
          delete-branch: true
          add-paths: |
            .terraform.lock.hcl
          commit-message: "chore(terraform): update .terraform.lock.hcl"
          title: "chore(terraform): update lockfile"
          body: |
            ⚠️ MANUAL REVIEW REQUIRED ⚠️

            This pull request was automatically created by CI to update
            `.terraform.lock.hcl` after running `terraform init`.

            What this PR does:
            - Updates Terraform provider versions and checksums only
            - Does NOT modify infrastructure resources or state
            - Does NOT apply any Terraform changes

            Merge requirements:
            - Human review and explicit approval is required
            - Merge using **Squash and merge** only
            - Do NOT rebase or merge-commit

            This workflow ensures deterministic provider versions across
            all environments and prevents unreviewed dependency drift.

            Please review the provider version diffs carefully before approving.
          reviewers: |
            maximcilek